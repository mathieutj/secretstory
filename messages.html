<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mes Secrets | SecretStory</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .glass { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .bg-gradient { background: radial-gradient(circle at bottom left, #1e1b4b, #4c1d95, #000000); }
        @keyframes pop {
    0% { transform: scale(0.9); opacity: 0; }
    100% { transform: scale(1); opacity: 1; }
}
.animate-pop { animation: pop 0.4s ease-out; }
        .secret-card {
            transition: transform 0.2s;
        }
        .secret-card:active { transform: scale(0.98); }
        
        /* Style pour la modal de r√©ponse (le visuel √† screener) */
        #responseCard {
            background: linear-gradient(135deg, #6366f1 0%, #a855f7 50%, #ec4899 100%);
        }
        .logout-btn {
    display: flex;
    align-items: center;
    gap: 8px;
    background: rgba(239, 68, 68, 0.1); /* Rouge tr√®s l√©ger */
    color: #ef4444; /* Rouge Tailwind */
    padding: 8px 16px;
    border-radius: 9999px;
    font-size: 12px;
    font-weight: 700;
    transition: all 0.2s ease;
    border: 1px solid rgba(239, 68, 68, 0.2);
}

.logout-btn:hover {
    background: rgba(239, 68, 68, 0.2);
    transform: translateY(-2px);
}

.logout-btn:active {
    transform: scale(0.95);
}
        
    </style>
</head>
<body class="bg-gradient text-white min-h-screen" onload="loadMySecrets()">

    <nav class="p-6 flex justify-between items-center border-b border-white/5">
        <h1 onclick="window.location.href='index.html'" class="text-xl font-extrabold bg-clip-text text-transparent bg-gradient-to-r from-purple-400 to-pink-600 cursor-pointer">
            SecretStory
        </h1>

        <div id="messageCounter" class="bg-purple-500/20 text-purple-400 px-3 py-1 rounded-full text-xs font-bold uppercase">
            0 Nouveau
        </div>

        <div class="w-full max-w-md flex justify-end px-4 mb-4">
            <button onclick="logout()" class="logout-btn">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                </svg>
                <span>Quitter</span>
            </button>
        </div>
    </nav>

    <main class="max-w-md mx-auto p-6">
        
        <header class="mb-8">
            <h2 class="text-2xl font-bold flex items-center gap-3">
                <span class="bg-clip-text text-transparent bg-gradient-to-r from-purple-400 to-pink-400">
                    Tes Secrets
                </span>
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-purple-400 -mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                </svg>
            </h2>
            <p class="text-gray-500 text-sm">Clique sur un message pour cr√©er ta r√©ponse WhatsApp.</p>
        </header>

        <div id="secretsContainer" class="space-y-4">
        </div>

        </div>
    </main>

    <div id="modalOverlay" class="fixed inset-0 bg-black/95 hidden flex-col items-center justify-center p-6 z-50">
    
        <div id="responseCard" class="w-full max-w-sm rounded-[2.5rem] p-10 flex flex-col items-center justify-center text-center shadow-2xl transition-all duration-500">
            
            <p class="text-white/60 text-[10px] font-black uppercase tracking-[0.3em] mb-6">Secret Anonyme</p>
            
            <h3 id="modalSecretText" class="text-2xl font-extrabold text-white leading-tight mb-8">
                "Chargement..."
            </h3>
    
            <div class="py-2 px-4 bg-black/20 rounded-full inline-block">
                <p class="bg-clip-text text-transparent bg-gradient-to-r from-white/90 to-white/40 text-[11px] font-black uppercase tracking-[0.2em]">
                    SECRETSTORY
                </p>
            </div>
        </div>
        <p class="text-white/50 mt-10 text-sm font-medium animate-bounce flex items-center justify-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
            <span>Capture l'√©cran !</span>
        </p>
        <button onclick="closeResponse()" class="mt-4 px-6 py-2 bg-white/5 rounded-full text-gray-400 text-[10px] font-bold uppercase tracking-widest">Fermer</button>
    </div>
    
    <script>
// On garde tes cl√©s Supabase
const supabaseUrl = 'https://esobynkttegitxvdeuyv.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVzb2J5bmt0dGVnaXR4dmRldXl2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjczNjE2MTcsImV4cCI6MjA4MjkzNzYxN30.jrvrusfMyAiYb5yUw7eBH3vhIRpx1663CoxpczZtYoI';
const _supabase = supabase.createClient(supabaseUrl, supabaseKey);

// 1. Charger les secrets
async function loadMySecrets() {
    const myUsername = localStorage.getItem('my_secret_username');
    if (!myUsername) {
        window.location.href = 'index.html';
        return;
    }

    const { data, error } = await _supabase
        .from('secrets')
        .select('*')
        .eq('receiver_username', myUsername)
        .order('created_at', { ascending: false });

    if (error) return console.error(error);

    // Mise √† jour du compteur (ton ID messageCounter)
    const counter = document.getElementById('messageCounter');
    if (counter) counter.innerText = `${data.length} Message${data.length > 1 ? 's' : ''}`;

    const container = document.getElementById('secretsContainer');
    container.innerHTML = "";

    if (data.length === 0) {
        container.innerHTML = `<p class="text-center text-gray-500 py-10 italic">Aucun secret re√ßu... pour l'instant ! ü§ê</p>`;
        return;
    }

    // Affichage des messages avec ton design
    data.forEach(secret => {
        const card = document.createElement('div');
        card.className = "glass p-5 rounded-2xl cursor-pointer hover:bg-white/10 transition-all active:scale-95 animate-pop";
        card.innerHTML = `
            <p class="text-white/90 text-lg mb-2">"${secret.content}"</p>
            <p class="text-[10px] text-gray-500 font-bold uppercase tracking-widest">Re√ßu anonymement</p>
        `;
        // Au clic, on ouvre TA modale de r√©ponse
        card.onclick = () => openResponse(secret.content);
        container.appendChild(card);
    });
    // √âcouter les nouveaux messages en temps r√©el
_supabase
  .channel('public:secrets')
  .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'secrets' }, payload => {
      console.log('Nouveau secret re√ßu !', payload.new);
      loadMySecrets(); // On relance le chargement automatiquement
  })
  .subscribe();
}

        function logout() {
            if (confirm("Se d√©connecter ?")) {
                localStorage.removeItem('my_secret_username');
                window.location.href = 'index.html';
            }
        }
        // Lancement au chargement
        window.addEventListener('DOMContentLoaded', loadMySecrets);

        function timeAgo(dateString) {
    if (!dateString) return "Date inconnue";
    
    const now = new Date();
    const past = new Date(dateString);
    const diffInSeconds = Math.floor((now - past) / 1000);

    // Si la date est invalide ou dans le futur (d√©calage horloge)
    if (diffInSeconds < 0) return "√Ä l'instant";

    if (diffInSeconds < 60) {
        return "√Ä l'instant";
    } else if (diffInSeconds < 3600) {
        const mins = Math.floor(diffInSeconds / 60);
        return `Il y a ${mins} min`;
    } else if (diffInSeconds < 86400) {
        const hours = Math.floor(diffInSeconds / 3600);
        return `Il y a ${hours}h`;
    } else if (diffInSeconds < 604800) {
        const days = Math.floor(diffInSeconds / 86400);
        return `Il y a ${days}j`;
    } else {
        // Au del√† d'une semaine, on affiche la date r√©elle
        return past.toLocaleDateString('fr-FR', {
            day: 'numeric',
            month: 'short'
        });
    }
}
        // Les 3 variantes de d√©grad√©s
        const themes = [
            "linear-gradient(135deg, #6366f1 0%, #a855f7 100%)", // Indigo - Violet
            "linear-gradient(135deg, #f43f5e 0%, #fb923c 100%)", // Rose - Orange
            "linear-gradient(135deg, #06b6d4 0%, #3b82f6 100%)"  // Cyan - Bleu
        ];
    
        let currentThemeIndex = 0;
    
        // 2. Fonctions pour la Modale (Capture d'√©cran)
function openResponse(text) {
    const modal = document.getElementById('modalOverlay');
    const modalText = document.getElementById('modalSecretText');
    const card = document.getElementById('responseCard');

    modalText.innerText = `"${text}"`;
    
    // On donne une couleur al√©atoire √† la carte pour chaque secret (tr√®s tendance sur Insta/Snap)
    const colors = [
        'linear-gradient(135deg, #6366f1 0%, #a855f7 100%)', // Indigo/Purple
        'linear-gradient(135deg, #f43f5e 0%, #fb923c 100%)', // Rose/Orange
        'linear-gradient(135deg, #06b6d4 0%, #3b82f6 100%)', // Cyan/Blue
        'linear-gradient(135deg, #10b981 0%, #3b82f6 100%)'  // Green/Blue
    ];
    card.style.background = colors[Math.floor(Math.random() * colors.length)];
    
    modal.classList.remove('hidden');
    modal.classList.add('flex');
}
    
        function closeResponse() {
    const modal = document.getElementById('modalOverlay');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
}
  
    // --- LOGIQUE PAGE ACCUEIL (Cr√©er son lien) ---
    async function createLink() {
      const username = document.querySelector('input').value.trim().toLowerCase();
      if (!username) return alert("Choisis un pseudo !");
  
      // On v√©rifie si le pseudo existe ou on l'enregistre
      const { error } = await _supabase.from('profiles').insert([{ username }]);
      
      if (!error || error.code === '23505') { // 23505 = d√©j√† existant, c'est ok
          localStorage.setItem('my_secret_username', username);
          window.location.href = 'success.html'; // Redirection
      } else {
          alert("Erreur : " + error.message);
      }
    }
  
    // --- LOGIQUE PAGE R√âCEPTION (Envoyer un secret) ---
    async function sendSecret() {
      // On r√©cup√®re le pseudo dans l'URL (ex: ?u=momo229)
      const urlParams = new URLSearchParams(window.location.search);
      const receiver = urlParams.get('u'); 
      const text = document.getElementById('secretInput').value;
  
      if (!text) return alert("√âcris quelque chose !");
  
      const { error } = await _supabase.from('secrets').insert([
          { receiver_username: receiver, content: text }
      ]);
  
      if (!error) {
          alert("Secret envoy√© !");
          document.getElementById('secretInput').value = "";
      }
    }
  </script>

</body>
</html>